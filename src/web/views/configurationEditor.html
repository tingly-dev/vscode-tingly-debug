<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0"
    >
    <title>Configuration Settings</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--vscode-panel-border);
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .launch-json-btn,
        .run-btn,
        .debug-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: 1px solid var(--vscode-button-border);
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            cursor: pointer;
            border-radius: 3px;
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            transition: background-color 0.2s;
        }

        .launch-json-btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .run-btn,
        .debug-btn {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        .run-btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .debug-btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .config-info {
            background-color: var(--vscode-textBlockQuote-background);
            border-left: 4px solid var(--vscode-textBlockQuote-border);
            padding: 10px 15px;
            margin-bottom: 20px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--vscode-foreground);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .field-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        label {
            flex: 0 0 120px;
            font-size: 13px;
            color: var(--vscode-foreground);
        }

        input[type="text"],
        select {
            flex: 1;
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            box-sizing: border-box;
            min-width: 0;
        }

        input[type="text"]:focus,
        select:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .hybrid-input {
            display: flex;
            gap: 5px;
            align-items: stretch;
            width: 100%;
        }

        .hybrid-input input[type="text"] {
            flex: 1;
            width: auto;
        }

        .hybrid-input select {
            flex: 0 0 auto;
            min-width: 130px;
            max-width: 200px;
        }

        .or-divider {
            color: var(--vscode-foreground);
            font-size: 12px;
            padding: 0 5px;
            display: flex;
            align-items: center;
            opacity: 0.7;
            white-space: nowrap;
        }

        .env-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .env-table th,
        .env-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--vscode-panel-border);
        }

        .env-table th {
            font-weight: bold;
            color: var(--vscode-foreground);
            font-size: 13px;
        }

        .env-table input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            padding: 4px 6px;
        }

        .env-table input[type="text"]:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .env-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .env-btn {
            background: none;
            border: 1px solid var(--vscode-button-border);
            color: var(--vscode-button-foreground);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-family: var(--vscode-font-family);
        }

        .env-btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .env-btn.remove {
            color: var(--vscode-errorForeground);
            border-color: var(--vscode-errorBorder);
        }

        .env-btn.remove:hover {
            background-color: var(--vscode-errorBackground);
        }

        .file-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }

        .file-input-group input[type="text"] {
            flex: 1;
        }

        .file-input-group button {
            flex: 0 0 auto;
            padding: 6px 12px;
            border: 1px solid var(--vscode-button-border);
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            cursor: pointer;
            border-radius: 3px;
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
        }

        .file-input-group button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--vscode-icon-foreground);
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            font-size: 16px;
        }

        .remove-btn:hover {
            background-color: var(--vscode-button-secondaryBackground);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        button {
            padding: 8px 16px;
            border: 1px solid var(--vscode-button-border);
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            cursor: pointer;
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            border-radius: 3px;
        }

        button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        button.primary {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        button.secondary {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }

        .json-view {
            margin-top: 20px;
            background-color: var(--vscode-textBlockQuote-background);
            border: 1px solid var(--vscode-panel-border);
            border-radius: 4px;
            padding: 15px;
            font-family: var(--vscode-editor-font-family);
            font-size: var(--vscode-editor-font-size);
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .error-message {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--vscode-errorBackground);
            border: 1px solid var(--vscode-errorBorder);
            border-radius: 4px;
            color: var(--vscode-errorForeground);
            font-size: var(--vscode-font-size);
            display: none;
        }

        .array-field {
            align-items: flex-start;
        }

        .array-badge {
            font-size: 10px;
            background-color: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
            font-weight: normal;
        }

        .field-content {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        .array-input-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .array-input-mode {
            display: flex;
            justify-content: flex-end;
        }

        .array-mode-buttons {
            display: flex;
            border: 1px solid var(--vscode-button-border);
            border-radius: 3px;
            overflow: hidden;
        }

        .array-mode-btn {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .array-mode-btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .array-mode-btn.active {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        .array-input-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .array-list-input {
            min-height: 80px;
            resize: vertical;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            padding: 6px 8px;
            border-radius: 3px;
        }

        .array-list-input:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .array-single-input {
            width: 100%;
        }

        .enhanced-select {
            background-color: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            border: 1px solid var(--vscode-dropdown-border);
            padding: 6px 8px;
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            border-radius: 3px;
        }

        .enhanced-select:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .enhanced-select:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .field-description {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            margin-top: 4px;
            margin-left: 2px;
            opacity: 0.8;
        }

        .help-icon {
            color: var(--vscode-descriptionForeground);
            cursor: pointer;
            margin-left: 6px;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s;
            position: relative;
        }

        .help-icon:hover {
            opacity: 1;
        }

        .help-popup {
            position: fixed;
            background-color: var(--vscode-editorWidget-background);
            border: 1px solid var(--vscode-editorWidget-border);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 11px;
            color: var(--vscode-editorWidget-foreground);
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
            z-index: 9999;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease;
            pointer-events: none;
            line-height: 1.4;
        }

        .help-popup.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .field-group-with-help {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 10px;
        }

        .field-group-with-help label {
            flex: 0 0 120px;
            font-size: 13px;
            color: var(--vscode-foreground);
            display: flex;
            align-items: center;
        }

        .field-group-with-help > div:not(.field-content) {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .field-group-with-help > div:not(.field-content) > input,
        .field-group-with-help > div:not(.field-content) > select,
        .field-group-with-help > div:not(.field-content) > .hybrid-input {
            width: 100%;
        }

        .properties-section {
            margin-left: 0;
            padding-left: 0;
        }

        .properties-section .field-group {
            padding-left: 0;
            margin-left: 0;
        }

        .add-field-section {
            margin-bottom: 25px;
        }

        .add-field-section .add-field-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }

        .add-field-section .add-field-group input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid var(--vscode-input-border);
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            border-radius: 3px;
            box-sizing: border-box;
        }

        .add-field-section .add-field-group input:focus {
            outline: 1px solid var(--vscode-focusBorder);
            outline-offset: -1px;
        }

        .add-field-section .add-field-group button {
            padding: 6px 12px;
            border: 1px solid var(--vscode-button-border);
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            cursor: pointer;
            border-radius: 3px;
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            white-space: nowrap;
        }

        .add-field-section .add-field-group button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h2>Configuration Settings</h2>
            <div class="header-actions">
                <button
                    type="button"
                    class="launch-json-btn"
                    onclick="openLaunchJson()"
                    title="Open launch.json file"
                >
                    <span class="codicon codicon-file-json"></span> launch.json
                </button>
                <button
                    type="button"
                    class="run-btn"
                    onclick="runConfiguration()"
                    title="Run configuration without breakpoints"
                >
                    <span class="codicon codicon-play"></span> Run
                </button>
                <button
                    type="button"
                    class="debug-btn"
                    onclick="debugConfiguration()"
                    title="Debug configuration with breakpoints"
                >
                    <span class="codicon codicon-debug-alt"></span> Debug
                </button>
                <button
                    type="button"
                    class="launch-json-btn"
                    onclick="saveConfiguration()"
                    title="Update configuration"
                >
                    <span class="codicon codicon-check"></span> Update
                </button>
            </div>
        </div>

        <form id="configForm">
            <div class="section">
                <div class="section-title">Basic Information</div>
                <div class="field-group-with-help">
                    <label for="configName">
                        name
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'name')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-name"
                            >The reader-friendly name to appear in the Debug launch configuration dropdown. This should
                                be descriptive and unique.</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <input
                            type="text"
                            id="configName"
                            name="name"
                            placeholder="Configuration name"
                        >
                    </div>
                </div>
                <div class="field-group-with-help">
                    <label for="configType">
                        type
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'type')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-type"
                            >The type of debugger to use. Every installed debug extension introduces a type (e.g., node
                                for Node.js, python for Python, chrome for Chrome debugging).</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <div class="hybrid-input">
                            <input
                                type="text"
                                id="configType"
                                name="type"
                                placeholder="Enter configuration type..."
                                oninput="clearTypeSelect()"
                            >
                            <div class="or-divider">or</div>
                            <select
                                id="configTypeSelect"
                                onchange="updateTypeFromSelect()"
                                class="enhanced-select"
                            >
                                <option value="">Select preset...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field-group-with-help">
                    <label for="configRequest">
                        request
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'request')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-request"
                            >The request type of this launch configuration. Currently supports 'launch' to start a new
                                process or 'attach' to connect to a running process.</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <div class="hybrid-input">
                            <input
                                type="text"
                                id="configRequest"
                                name="request"
                                placeholder="Enter request type..."
                                oninput="clearRequestSelect()"
                            >
                            <div class="or-divider">or</div>
                            <select
                                id="configRequestSelect"
                                onchange="updateRequestFromSelect()"
                                class="enhanced-select"
                            >
                                <option value="">Select preset...</option>
                                <option value="launch">üöÄ Launch - Start a new process</option>
                                <option value="attach">üîó Attach - Connect to running process</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field-group-with-help">
                    <label for="configProgram">
                        program
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'program')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-program"
                            >The executable or script to run when launching the debugger. This can be an absolute path
                                or use variables like ${workspaceFolder}, ${file}, etc.</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <div class="hybrid-input">
                            <input
                                type="text"
                                id="configProgram"
                                name="program"
                                placeholder="Enter program path..."
                            >
                            <button
                                type="button"
                                onclick="browseProgram()"
                                style="padding: 6px 12px; border: 1px solid var(--vscode-button-border); background-color: var(--vscode-button-secondaryBackground); color: var(--vscode-button-secondaryForeground); cursor: pointer; border-radius: 3px; font-family: var(--vscode-font-family); font-size: var(--vscode-font-size);"
                            >Browse</button>
                        </div>
                    </div>
                </div>
                <div class="field-group-with-help">
                    <label for="configMode">
                        mode
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'mode')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-mode"
                            >The debug mode. Some debuggers support different modes like 'debug' vs 'release' or
                                language-specific modes. Check your debugger documentation for available options.</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <input
                            type="text"
                            id="configMode"
                            name="mode"
                            placeholder="Enter debug mode..."
                        >
                    </div>
                </div>
                <div class="field-group-with-help">
                    <label for="configArgs">
                        args
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'args')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-args"
                            >Command line arguments passed to the program. You can enter as a JSON array or use
                                variables like ${file}, ${workspaceFolder}, etc.</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <div
                            class="array-input-container"
                            id="array-container-args"
                        >
                            <div class="array-input-mode">
                                <div class="array-mode-buttons">
                                    <button
                                        type="button"
                                        class="array-mode-btn active"
                                        onclick="setArrayMode('args', 'single')"
                                        title="Single line input"
                                    >
                                        <span class="codicon codicon-symbol-string"></span>
                                    </button>
                                    <button
                                        type="button"
                                        class="array-mode-btn"
                                        onclick="setArrayMode('args', 'list')"
                                        title="List input"
                                    >
                                        <span class="codicon codicon-list-flat"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="array-input-content">
                                <input
                                    type="text"
                                    id="configArgs"
                                    name="args"
                                    placeholder='Enter JSON array for arguments (e.g., ["arg1", "arg2"])'
                                    class="array-single-input"
                                    oninput="updateJsonPreview()"
                                >
                                <textarea
                                    id="configArgs-list"
                                    name="args-list"
                                    placeholder="Enter one argument per line"
                                    class="array-list-input"
                                    style="display: none;"
                                    oninput="updateJsonPreviewFromList('args')"
                                ></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="field-group-with-help">
                    <label for="configModule">
                        module
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'module')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-module"
                            >Module path or name to debug. Used by some debuggers to specify which module to load and
                                debug.</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <input
                            type="text"
                            id="configModule"
                            name="module"
                            placeholder="Enter module path or name..."
                        >
                    </div>
                </div>
                <div class="field-group-with-help">
                    <label for="configCwd">
                        cwd
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'cwd')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-cwd"
                            >The working directory for the debug session. Defaults to the workspace folder. Can use
                                variables like ${workspaceFolder}.</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <div class="hybrid-input">
                            <input
                                type="text"
                                id="configCwd"
                                name="cwd"
                                placeholder="Enter working directory path..."
                            >
                            <button
                                type="button"
                                onclick="browseCwd()"
                                style="padding: 6px 12px; border: 1px solid var(--vscode-button-border); background-color: var(--vscode-button-secondaryBackground); color: var(--vscode-button-secondaryForeground); cursor: pointer; border-radius: 3px; font-family: var(--vscode-font-family); font-size: var(--vscode-font-size);"
                            >Browse</button>
                        </div>
                    </div>
                </div>
                <div class="field-group-with-help">
                    <label for="configJustMyCode">
                        justMyCode
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'justMyCode')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-justMyCode"
                            >Only debug user-written code and skip through system/library code. When enabled, the
                                debugger will only stop in user code.</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <div class="hybrid-input">
                            <input
                                type="text"
                                id="configJustMyCode"
                                name="justMyCode"
                                placeholder="Enter true or false..."
                                oninput="clearJustMyCodeSelect()"
                            >
                            <div class="or-divider">or</div>
                            <select
                                id="configJustMyCodeSelect"
                                onchange="updateJustMyCodeFromSelect()"
                                class="enhanced-select"
                            >
                                <option value="">Select preset...</option>
                                <option value="true">‚úÖ Enabled - Only debug user code</option>
                                <option value="false">‚ùå Disabled - Debug all code</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Environment Variables
                    <span
                        class="help-icon"
                        onclick="toggleHelp(event, 'environment')"
                        style="margin-left: 10px;"
                    >‚ìò
                        <div
                            class="help-popup"
                            id="help-environment"
                        >Environment variables for the debug session. You can set key-value pairs or use envFile to load
                            variables from a .env file. These variables are available to your program during debugging.
                        </div>
                    </span>
                </div>

                <div class="file-input-group">
                    <label
                        for="envFile"
                        style="flex: 0 0 auto; min-width: 80px;"
                    >envFile</label>
                    <input
                        type="text"
                        id="envFile"
                        name="envFile"
                        placeholder="${workspaceFolder}/.env"
                    >
                    <button
                        type="button"
                        onclick="openEnvFile()"
                    >Open</button>
                </div>

                <div class="field-group-with-help">
                    <label for="env">
                        env
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'env')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-env"
                            >Environment variables as key-value pairs for the debug session. These variables are
                                available to your program during debugging.</div>
                        </span>
                    </label>
                </div>

                <div style="margin-bottom: 15px;">
                    <table
                        class="env-table"
                        id="envTable"
                    >
                        <thead>
                            <tr>
                                <th style="width: 35%;">Variable Name</th>
                                <th style="width: 45%;">Value</th>
                                <th style="width: 20%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="envTableBody">
                            <tr id="emptyEnvRow">
                                <td
                                    colspan="3"
                                    style="text-align: center; opacity: 0.6; padding: 20px;"
                                >No environment variables configured. Click "Add Variable" to get started.</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="env-actions">
                        <button
                            type="button"
                            class="env-btn"
                            onclick="addEnvRow()"
                        >‚ûï Add Variable</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Session Configuration</div>
                <div class="field-group-with-help">
                    <label for="configConsole">
                        console
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'console')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-console"
                            >What kind of console to use for the debug session. Options: internalConsole (VSCode debug
                                console), integratedTerminal (VSCode terminal), or externalTerminal (system terminal).
                            </div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <div class="hybrid-input">
                            <input
                                type="text"
                                id="configConsole"
                                name="console"
                                placeholder="Enter console type..."
                                oninput="clearConsoleSelect()"
                            >
                            <div class="or-divider">or</div>
                            <select
                                id="configConsoleSelect"
                                onchange="updateConsoleFromSelect()"
                                class="enhanced-select"
                            >
                                <option value="">Select preset...</option>
                                <option value="internalConsole">üìü Internal Console - VSCode debug console</option>
                                <option value="integratedTerminal">üíª Integrated Terminal - VSCode terminal</option>
                                <option value="externalTerminal">üñ•Ô∏è External Terminal - System terminal</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field-group-with-help">
                    <label for="configInternalConsole">
                        internalConsoleOptions
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'internalConsole')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-internalConsole"
                            >Controls the visibility of the Debug console panel during a debugging session. Options:
                                neverOpen, openOnSessionStart, or openOnFirstSessionStart.</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <div class="hybrid-input">
                            <input
                                type="text"
                                id="configInternalConsole"
                                name="internalConsoleOptions"
                                placeholder="Enter internal console option..."
                                oninput="clearInternalConsoleSelect()"
                            >
                            <div class="or-divider">or</div>
                            <select
                                id="configInternalConsoleSelect"
                                onchange="updateInternalConsoleFromSelect()"
                                class="enhanced-select"
                            >
                                <option value="">Select preset...</option>
                                <option value="neverOpen">‚ùå Never Open - Don't open debug console</option>
                                <option value="openOnSessionStart">üîÑ Open on Start - Open when debugging starts
                                </option>
                                <option value="openOnFirstSessionStart">üîî Open on First Start - Open for first debug
                                    session</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field-group-with-help">
                    <label for="configPreLaunchTask">
                        preLaunchTask
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'preLaunchTask')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-preLaunchTask"
                            >Task to run before the start of a debug session. Set to the label of a task specified in
                                tasks.json or use ${defaultBuildTask} for your default build task.</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <div class="hybrid-input">
                            <input
                                type="text"
                                id="configPreLaunchTask"
                                name="preLaunchTask"
                                placeholder="Enter task name or ${defaultBuildTask}..."
                                oninput="clearPreLaunchTaskSelect()"
                            >
                            <div class="or-divider">or</div>
                            <select
                                id="configPreLaunchTaskSelect"
                                onchange="updatePreLaunchTaskFromSelect()"
                                class="enhanced-select"
                            >
                                <option value="">Select preset...</option>
                                <option value="${defaultBuildTask}">üî® Default Build Task</option>
                                <option value="npm: build">üì¶ NPM: Build</option>
                                <option value="npm: compile">üìù NPM: Compile</option>
                                <option value="npm: test">üß™ NPM: Test</option>
                                <option value="gradle: build">üêò Gradle: Build</option>
                                <option value="cargo: build">ü¶Ä Cargo: Build</option>
                                <option value="make: all">‚öôÔ∏è Make: All</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field-group-with-help">
                    <label for="configPostDebugTask">
                        postDebugTask
                        <span
                            class="help-icon"
                            onclick="toggleHelp(event, 'postDebugTask')"
                        >‚ìò
                            <div
                                class="help-popup"
                                id="help-postDebugTask"
                            >Task to run at the very end of a debug session. Set to the label of a task specified in
                                tasks.json for cleanup or post-processing.</div>
                        </span>
                    </label>
                    <div style="flex: 1;">
                        <div class="hybrid-input">
                            <input
                                type="text"
                                id="configPostDebugTask"
                                name="postDebugTask"
                                placeholder="Enter task name..."
                                oninput="clearPostDebugTaskSelect()"
                            >
                            <div class="or-divider">or</div>
                            <select
                                id="configPostDebugTaskSelect"
                                onchange="updatePostDebugTaskFromSelect()"
                                class="enhanced-select"
                            >
                                <option value="">Select preset...</option>
                                <option value="npm: clean">üßπ NPM: Clean</option>
                                <option value="npm: lint">üîç NPM: Lint</option>
                                <option value="npm: coverage">üìä NPM: Coverage</option>
                                <option value="docker: stop">üê≥ Docker: Stop</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div
                    id="errorMessage"
                    class="error-message"
                ></div>
            </div>

    <div class="section">
        <div class="section-title">
            Configuration Properties
            <span
                class="help-icon"
                onclick="toggleHelp(event, 'properties')"
                style="margin-left: 10px;"
            >‚ìò
                <div
                    class="help-popup"
                    id="help-properties"
                >Additional properties specific to your debugger type. Common properties include: program
                    (executable), args (arguments), cwd (working directory), port (for attach), and many
                    debugger-specific options.</div>
            </span>
        </div>
        <div id="propertiesContainer" class="properties-section">
        </div>
    </div>

    <div class="section add-field-section">
        <div class="section-title">Add New Property</div>
        <div class="add-field-group">
            <input
                type="text"
                id="newPropName"
                placeholder="Property name"
            >
            <input
                type="text"
                id="newPropValue"
                placeholder="Property value"
            >
            <button
                type="button"
                onclick="addField()"
            >Add Property</button>
        </div>
    </div>

    <div
        class="section"
        style="border-top: 1px solid var(--vscode-panel-border); padding-top: 20px; margin-top: 20px;"
    >
        <div class="section-title">JSON Preview</div>
        <div
            id="jsonPreview"
            class="json-view"
        ></div>
    </div>

    <div class="button-group">
        <!-- <button
                    type="button"
                    class="secondary"
                    onclick="reset()"
                >Reset</button> -->
        <button
            type="button"
            class="primary"
            onclick="saveConfiguration()"
        >Update</button>
    </div>
    </form>
    </div>

    <script>
        const vscode = acquireVsCodeApi();

        // Store initial configuration for change detection
        let initialConfig = '';
        let isDirty = false;
        let envRowIndex = 0;
        let commonTypes = [];

        // Debug function to check if all required DOM elements are present
        function debugDomElements() {
            const requiredElements = [
                'configForm',
                'jsonPreview',
                'configName',
                'configType',
                'configRequest',
                'configProgram',
                'configMode',
                'configArgs',
                'configArgs-list'
            ];

            const missingElements = requiredElements.filter(id => !document.getElementById(id));

            if (missingElements.length > 0) {
                console.error('Missing DOM elements:', missingElements);
                return false;
            }

            console.log('All required DOM elements are present');
            return true;
        }

        // Initialize the page with data from extension
        function initializePage(data) {
            try {

                // Store data globally
                initialConfig = JSON.stringify(data.config, null, 2);
                commonTypes = data.commonTypes || [];

                // Populate form fields
                document.getElementById('configName').value = data.config.name || '';
                document.getElementById('configType').value = data.config.type || '';
                document.getElementById('configRequest').value = data.config.request || '';
                document.getElementById('configProgram').value = data.config.program || '';
                document.getElementById('configMode').value = data.config.mode || '';
                document.getElementById('configModule').value = data.config.module || '';
                document.getElementById('configCwd').value = data.config.cwd || '';
                document.getElementById('configJustMyCode').value = data.config.justMyCode !== undefined ? String(data.config.justMyCode) : '';

                // Set justMyCode dropdown
                if (['true', 'false'].includes(String(data.config.justMyCode))) {
                    document.getElementById('configJustMyCodeSelect').value = String(data.config.justMyCode);
                }

                // Handle args field
                const argsValue = data.config.args || [];
                if (Array.isArray(argsValue) && argsValue.length > 0) {
                    const listValues = argsValue.map(item => String(item)).join('\n');
                    const shouldUseListMode = argsValue.length > 1 || argsValue.some(item => String(item).length > 30);

                    setTimeout(() => {
                        const singleInput = document.getElementById('configArgs');
                        const listInput = document.getElementById('configArgs-list');

                        if (singleInput) {
                            singleInput.value = JSON.stringify(argsValue);
                        }
                        if (listInput) {
                            listInput.value = listValues;
                        }

                        if (shouldUseListMode) {
                            setArrayMode('args', 'list');
                        }
                    }, 0);
                } else {
                    setTimeout(() => {
                        document.getElementById('configArgs').value = Array.isArray(argsValue) ? JSON.stringify(argsValue) : '';
                    }, 0);
                }

                document.getElementById('configConsole').value = data.config.console || '';
                document.getElementById('configInternalConsole').value = data.config.internalConsoleOptions || '';
                document.getElementById('configPreLaunchTask').value = data.config.preLaunchTask || '';
                document.getElementById('configPostDebugTask').value = data.config.postDebugTask || '';

                // Populate type dropdown
                populateTypeDropdown();

                // Populate environment variables
                populateEnvironmentVariables(data.config.env || {});

                // Set env file
                document.getElementById('envFile').value = data.config.envFile || '';

                // Populate properties
                populateProperties(data.config.properties || {});

                // Set request dropdown
                if (['launch', 'attach'].includes(data.config.request)) {
                    document.getElementById('configRequestSelect').value = data.config.request;
                }

                // Set console dropdown
                if (['internalConsole', 'integratedTerminal', 'externalTerminal'].includes(data.config.console)) {
                    document.getElementById('configConsoleSelect').value = data.config.console;
                }

                // Set internal console dropdown
                if (['neverOpen', 'openOnSessionStart', 'openOnFirstSessionStart'].includes(data.config.internalConsoleOptions)) {
                    document.getElementById('configInternalConsoleSelect').value = data.config.internalConsoleOptions;
                }

                // Initialize JSON preview
                setTimeout(() => {
                    debugDomElements();
                    updateJsonPreview();
                }, 100);

            } catch (error) {
                console.error('Error initializing page:', error);
                showError('Failed to initialize configuration editor');
            }
        }

        function populateTypeDropdown() {
            const select = document.getElementById('configTypeSelect');
            select.innerHTML = '<option value="">Select preset...</option>';

            const typeDescriptions = {
                'python': 'Python - Python debugging (Well supported)',
                'go': 'Go - Go language debugging (Well supported)'
            };

            commonTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = typeDescriptions[type] || type;
                if (type === document.getElementById('configType').value) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function populateEnvironmentVariables(env) {
            const tbody = document.getElementById('envTableBody');
            tbody.innerHTML = '';

            const envEntries = Object.entries(env);
            envRowIndex = envEntries.length;

            if (envEntries.length === 0) {
                tbody.innerHTML = '<tr id="emptyEnvRow"><td colspan="3" style="text-align: center; opacity: 0.6; padding: 20px;">No environment variables configured. Click "Add Variable" to get started.</td></tr>';
            } else {
                envEntries.forEach(([key, value], index) => {
                    addEnvRowWithValue(key, value, index);
                });
            }
        }

        function addEnvRowWithValue(key, value, index) {
            const tbody = document.getElementById('envTableBody');
            const displayValue = typeof value === 'string' ? value : JSON.stringify(value);

            const row = document.createElement('tr');
            row.setAttribute('data-index', index);
            row.innerHTML = `
                <td>
                    <input type="text" id="env-key-${index}" name="env-key-${index}" value="${key.replace(/"/g, '&quot;')}" placeholder="Environment variable name">
                </td>
                <td>
                    <input type="text" id="env-value-${index}" name="env-value-${index}" value="${displayValue.replace(/"/g, '&quot;')}" placeholder="Environment variable value">
                </td>
                <td class="env-actions">
                    <button type="button" class="env-btn remove" onclick="removeEnvRow(${index})" title="Remove variable">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);

            // Add event listeners to new inputs
            row.querySelectorAll('input[type="text"]').forEach(input => {
                input.addEventListener('input', updateJsonPreview);
            });
        }

        function populateProperties(properties) {
            const container = document.getElementById('propertiesContainer');
            container.innerHTML = '';

            // Skip program, mode, args, module, cwd, and justMyCode fields as they are now in Basic Information
            const skippedFields = ['program', 'mode', 'args', 'module', 'cwd', 'justMyCode'];

            Object.entries(properties).forEach(([key, value]) => {
                if (!skippedFields.includes(key)) {
                    addPropertyField(key, value);
                }
            });
        }

        function addPropertyField(key, value) {
            const container = document.getElementById('propertiesContainer');
            const isArray = isArrayProperty(key);

            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'field-group' + (isArray ? ' array-field' : '');

            let inputHtml;

            if (isArray) {
                const arrayValues = Array.isArray(value) ? value : [];
                const listValues = arrayValues.map(item => String(item)).join('\n');
                const shouldUseListMode = arrayValues.length > 1 || arrayValues.some(item => String(item).length > 30);

                inputHtml = '<div class="array-input-container" id="array-container-' + key + '">' +
                    '<div class="array-input-mode">' +
                    '<div class="array-mode-buttons">' +
                    '<button type="button" class="array-mode-btn ' + (!shouldUseListMode ? 'active' : '') + '"' +
                    ' onclick="setArrayMode(\'' + key + '\', \'single\')" title="Single line input">' +
                    '<span class="codicon codicon-symbol-string"></span>' +
                    '</button>' +
                    '<button type="button" class="array-mode-btn ' + (shouldUseListMode ? 'active' : '') + '"' +
                    ' onclick="setArrayMode(\'' + key + '\', \'list\')" title="List input">' +
                    '<span class="codicon codicon-list-flat"></span>' +
                    '</button>' +
                    '</div>' +
                    '</div>' +
                    '<div class="array-input-content">' +
                    '<input type="text" id="prop-' + key + '" name="' + key + '"' +
                    ' placeholder="Enter JSON array for ' + key + ' (e.g., [&quot;value1&quot;, &quot;value2&quot;])"' +
                    ' class="array-single-input"' +
                    ' style="' + (shouldUseListMode ? 'display: none;' : '') + '"' +
                    ' oninput="updateJsonPreview()">' +
                    '<textarea id="prop-' + key + '-list" name="' + key + '-list"' +
                    ' placeholder="Enter one value per line for ' + key + '"' +
                    ' class="array-list-input"' +
                    ' style="' + (shouldUseListMode ? '' : 'display: none;') + '"' +
                    ' oninput="updateJsonPreviewFromList(\'' + key + '\')">' + escapeHtmlTags(listValues) + '</textarea>' +
                    '</div>' +
                    '</div>';

                // Set the single input value
                if (arrayValues.length > 0) {
                    setTimeout(() => {
                        const singleInput = document.getElementById('prop-' + key);
                        if (singleInput) {
                            singleInput.value = JSON.stringify(arrayValues);
                        }
                    }, 0);
                }
            } else {
                const displayValue = typeof value === 'string' ? value : JSON.stringify(value);
                inputHtml = '<input type="text" id="prop-' + key + '" name="' + key + '"' +
                    ' value="' + displayValue.replace(/"/g, '&quot;') + '"' +
                    ' placeholder="Enter ' + key + '"' +
                    ' oninput="updateJsonPreview()">';
            }

            fieldDiv.innerHTML =
                '<label for="prop-' + key + '">' + key + (isArray ? '<span class="array-badge">Array</span>' : '') + '</label>' +
                '<div class="field-content">' +
                inputHtml +
                '<button type="button" class="remove-btn" onclick="removeField(\'' + key + '\')">üóëÔ∏è</button>' +
                '</div>';

            container.appendChild(fieldDiv);

            // Add event listeners
            fieldDiv.querySelectorAll('input[type="text"], textarea').forEach(input => {
                input.addEventListener('input', updateJsonPreview);
            });
        }

        function isArrayProperty(key) {
            return ['args', 'outFiles', 'configurations', 'inputs'].includes(key);
        }

        function escapeHtmlTags(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // Array input handling functions
        function setArrayMode(propertyName, mode) {
            const singleInput = document.getElementById('prop-' + propertyName);
            const listInput = document.getElementById('prop-' + propertyName + '-list');
            const singleBtn = document.querySelector('#array-container-' + propertyName + ' .array-mode-btn:first-child');
            const listBtn = document.querySelector('#array-container-' + propertyName + ' .array-mode-btn:last-child');

            if (mode === 'single') {
                if (listInput && singleInput) {
                    const listValue = listInput.value.trim();
                    if (listValue) {
                        const arrayValue = listValue.split('\n')
                            .map(line => line.trim())
                            .filter(line => line.length > 0)
                            .map(line => {
                                try {
                                    return JSON.parse(line);
                                } catch {
                                    return line;
                                }
                            });
                        singleInput.value = JSON.stringify(arrayValue);
                    } else {
                        singleInput.value = '[]';
                    }
                }

                if (singleInput) singleInput.style.display = 'block';
                if (listInput) listInput.style.display = 'none';
                if (singleBtn) singleBtn.classList.add('active');
                if (listBtn) listBtn.classList.remove('active');
            } else if (mode === 'list') {
                if (singleInput && listInput) {
                    const singleValue = singleInput.value.trim();
                    if (singleValue) {
                        try {
                            const arrayValue = JSON.parse(singleValue);
                            if (Array.isArray(arrayValue)) {
                                listInput.value = arrayValue.map(item => String(item)).join('\n');
                            } else {
                                listInput.value = String(arrayValue);
                            }
                        } catch {
                            const arrayValue = singleValue.split(',').map(item => item.trim()).filter(item => item);
                            listInput.value = arrayValue.join('\n');
                        }
                    }
                }

                if (singleInput) singleInput.style.display = 'none';
                if (listInput) listInput.style.display = 'block';
                if (singleBtn) singleBtn.classList.remove('active');
                if (listBtn) listBtn.classList.add('active');
            }

            updateJsonPreview();
        }

        function updateJsonPreviewFromList(propertyName) {
            const listInput = document.getElementById('prop-' + propertyName + '-list');
            const singleInput = document.getElementById('prop-' + propertyName);

            if (listInput && singleInput) {
                const listValue = listInput.value.trim();
                if (listValue) {
                    const arrayValue = listValue.split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0)
                        .map(line => {
                            try {
                                return JSON.parse(line);
                            } catch {
                                return line;
                            }
                        });
                    singleInput.value = JSON.stringify(arrayValue);
                } else {
                    singleInput.value = '[]';
                }
            }

            updateJsonPreview();
        }

        function updateTypeFromSelect() {
            const select = document.getElementById('configTypeSelect');
            const input = document.getElementById('configType');

            if (select.value) {
                input.value = select.value;
            }
            updateJsonPreview();
        }

        function updateRequestFromSelect() {
            const select = document.getElementById('configRequestSelect');
            const input = document.getElementById('configRequest');

            if (select.value) {
                input.value = select.value;
            }
            updateJsonPreview();
        }

        function clearTypeSelect() {
            document.getElementById('configTypeSelect').value = '';
        }

        function clearRequestSelect() {
            document.getElementById('configRequestSelect').value = '';
        }

        function updateConsoleFromSelect() {
            const select = document.getElementById('configConsoleSelect');
            const input = document.getElementById('configConsole');

            if (select.value) {
                input.value = select.value;
            }
            updateJsonPreview();
        }

        function clearConsoleSelect() {
            document.getElementById('configConsoleSelect').value = '';
        }

        function updateInternalConsoleFromSelect() {
            const select = document.getElementById('configInternalConsoleSelect');
            const input = document.getElementById('configInternalConsole');

            if (select.value) {
                input.value = select.value;
            }
            updateJsonPreview();
        }

        function clearInternalConsoleSelect() {
            document.getElementById('configInternalConsoleSelect').value = '';
        }

        function updatePreLaunchTaskFromSelect() {
            const select = document.getElementById('configPreLaunchTaskSelect');
            const input = document.getElementById('configPreLaunchTask');

            if (select.value) {
                input.value = select.value;
            }
            updateJsonPreview();
        }

        function clearPreLaunchTaskSelect() {
            document.getElementById('configPreLaunchTaskSelect').value = '';
        }

        function updatePostDebugTaskFromSelect() {
            const select = document.getElementById('configPostDebugTaskSelect');
            const input = document.getElementById('configPostDebugTask');

            if (select.value) {
                input.value = select.value;
            }
            updateJsonPreview();
        }

        function clearPostDebugTaskSelect() {
            document.getElementById('configPostDebugTaskSelect').value = '';
        }

        function updateJustMyCodeFromSelect() {
            const select = document.getElementById('configJustMyCodeSelect');
            const input = document.getElementById('configJustMyCode');

            if (select.value) {
                input.value = select.value;
            }
            updateJsonPreview();
        }

        function clearJustMyCodeSelect() {
            document.getElementById('configJustMyCodeSelect').value = '';
        }

        function toggleHelp(event, fieldName) {
            event.stopPropagation();

            // Hide all other help popups first
            document.querySelectorAll('.help-popup.visible').forEach(popup => {
                if (popup.id !== `help-${fieldName}`) {
                    popup.classList.remove('visible');
                }
            });

            const popup = document.getElementById(`help-${fieldName}`);
            if (popup) {
                // Position the popup
                const rect = event.target.getBoundingClientRect();
                popup.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
                popup.style.left = (rect.left + rect.width / 2) + 'px';
                popup.style.transform = 'translateX(-50%)';

                popup.classList.toggle('visible');
            }
        }

        // Hide all help popups when clicking outside
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.help-icon')) {
                document.querySelectorAll('.help-popup.visible').forEach(popup => {
                    popup.classList.remove('visible');
                });
            }
        });

        // Hide all help popups on Escape key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.help-popup.visible').forEach(popup => {
                    popup.classList.remove('visible');
                });
            }
        });

        // Add hover functionality for help icons
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.help-icon').forEach(icon => {
                icon.addEventListener('mouseenter', function (e) {
                    const fieldName = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                    const popup = document.getElementById(`help-${fieldName}`);
                    if (popup) {
                        // Position the popup
                        const rect = this.getBoundingClientRect();
                        popup.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
                        popup.style.left = (rect.left + rect.width / 2) + 'px';
                        popup.style.transform = 'translateX(-50%)';

                        popup.classList.add('visible');
                    }
                });

                icon.addEventListener('mouseleave', function (e) {
                    const fieldName = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                    const popup = document.getElementById(`help-${fieldName}`);
                    if (popup) {
                        setTimeout(() => {
                            popup.classList.remove('visible');
                        }, 100);
                    }
                });
            });

            // Keep popup open when hovering over it
            document.querySelectorAll('.help-popup').forEach(popup => {
                popup.addEventListener('mouseenter', function () {
                    this.classList.add('visible');
                });

                popup.addEventListener('mouseleave', function () {
                    this.classList.remove('visible');
                });
            });
        });

        function addEnvRow() {
            const tbody = document.getElementById('envTableBody');

            const emptyRow = document.getElementById('emptyEnvRow');
            if (emptyRow) {
                emptyRow.remove();
            }

            const index = envRowIndex++;
            addEnvRowWithValue('', '', index);

            document.getElementById(`env-key-${index}`).focus();
            updateJsonPreview();
        }

        function removeEnvRow(index) {
            const row = document.querySelector(`#env-key-${index}`)?.closest('tr');
            if (row) {
                row.remove();

                const tbody = document.getElementById('envTableBody');
                if (tbody.children.length === 0) {
                    tbody.innerHTML = '<tr id="emptyEnvRow"><td colspan="3" style="text-align: center; opacity: 0.6; padding: 20px;">No environment variables configured. Click "Add Variable" to get started.</td></tr>';
                }

                updateJsonPreview();
            }
        }

        function openEnvFile() {
            const currentValue = document.getElementById('envFile').value;
            vscode.postMessage({
                command: 'browseEnvFile',
                currentPath: currentValue || '${workspaceFolder}/.env'
            });
        }

        function browseProgram() {
            const currentValue = document.getElementById('configProgram').value;
            vscode.postMessage({
                command: 'browseProgram',
                currentPath: currentValue || '${workspaceFolder}'
            });
        }

        function browseCwd() {
            const currentValue = document.getElementById('configCwd').value;
            vscode.postMessage({
                command: 'browseCwd',
                currentPath: currentValue || '${workspaceFolder}'
            });
        }

        function getEnvObject() {
            const env = {};
            const envInputs = document.querySelectorAll('[id^="env-key-"]');

            envInputs.forEach(input => {
                const key = input.value.trim();
                const index = input.id.split('-')[2];
                const valueInput = document.getElementById(`env-value-${index}`);
                const value = valueInput ? valueInput.value.trim() : '';

                if (key) {
                    env[key] = value;
                }
            });

            return env;
        }

        function checkForChanges() {
            const currentConfig = getCurrentFormConfig();
            const currentConfigJson = JSON.stringify(currentConfig, null, 2);
            const hasChanges = currentConfigJson !== initialConfig;

            isDirty = hasChanges;

            if (hasChanges) {
                document.title = document.title.replace(/^[‚óè]?\s*/, '‚óè ');
            } else {
                document.title = document.title.replace(/^[‚óè]\s*/, '');
            }
        }

        function getCurrentFormConfig() {
            try {
                const form = document.getElementById('configForm');
                if (!form) {
                    console.error('Form element not found');
                    return {};
                }

                const formData = new FormData(form);
                const config = {};

                // Handle special fields first
                const configProgram = document.getElementById('configProgram');
                if (configProgram && configProgram.value.trim()) {
                    config.program = configProgram.value.trim();
                }

                const configMode = document.getElementById('configMode');
                if (configMode && configMode.value.trim()) {
                    config.mode = configMode.value.trim();
                }

                const configModule = document.getElementById('configModule');
                if (configModule && configModule.value.trim()) {
                    config.module = configModule.value.trim();
                }

                const configCwd = document.getElementById('configCwd');
                if (configCwd && configCwd.value.trim()) {
                    config.cwd = configCwd.value.trim();
                }

                const configJustMyCode = document.getElementById('configJustMyCode');
                if (configJustMyCode && configJustMyCode.value.trim()) {
                    const justMyCodeValue = configJustMyCode.value.trim().toLowerCase();
                    config.justMyCode = justMyCodeValue === 'true' ? true : justMyCodeValue === 'false' ? false : justMyCodeValue;
                }

                // Handle args field specially
                const argsValue = getArrayFieldValue('args');
                if (argsValue && argsValue.length > 0) {
                    config.args = argsValue;
                }

                for (let [key, value] of formData.entries()) {
                    if (key && !key.startsWith('env-') && !key.endsWith('-list') && !['program', 'mode', 'args', 'module', 'cwd', 'justMyCode'].includes(key)) {
                        const isArrayField = isArrayProperty(key);

                        if (isArrayField) {
                            const actualValue = getArrayFieldValue(key);
                            config[key] = actualValue;
                        } else {
                            try {
                                config[key] = JSON.parse(value);
                            } catch {
                                config[key] = value;
                            }
                        }
                    }
                }

                const env = getEnvObject();
                if (Object.keys(env).length > 0) {
                    config.env = env;
                }

                const envFileInput = document.getElementById('envFile');
                if (envFileInput) {
                    const envFile = envFileInput.value.trim();
                    if (envFile) {
                        config.envFile = envFile;
                    }
                }

                return config;
            } catch (error) {
                console.error('Error getting form configuration:', error);
                return {};
            }
        }

        function getArrayFieldValue(key) {
            // Handle args field specially since it's not in properties
            if (key === 'args') {
                const singleInput = document.getElementById('configArgs');
                const listInput = document.getElementById('configArgs-list');

                if (!singleInput) return [];

                const isListMode = listInput && listInput.style.display !== 'none';

                if (isListMode && listInput) {
                    const listValue = listInput.value.trim();
                    if (!listValue) return [];

                    return listValue.split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0)
                        .map(line => {
                            try {
                                return JSON.parse(line);
                            } catch {
                                return line;
                            }
                        });
                } else {
                    const singleValue = singleInput.value.trim();
                    if (!singleValue) return [];

                    try {
                        const parsed = JSON.parse(singleValue);
                        return Array.isArray(parsed) ? parsed : [parsed];
                    } catch {
                        return singleValue.split(',').map(item => {
                            const trimmed = item.trim();
                            try {
                                return JSON.parse(trimmed);
                            } catch {
                                return trimmed;
                            }
                        });
                    }
                }
            }

            // Handle other array fields in properties
            const singleInput = document.getElementById('prop-' + key);
            const listInput = document.getElementById('prop-' + key + '-list');

            if (!singleInput) return [];

            const isListMode = listInput && listInput.style.display !== 'none';

            if (isListMode && listInput) {
                const listValue = listInput.value.trim();
                if (!listValue) return [];

                return listValue.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .map(line => {
                        try {
                            return JSON.parse(line);
                        } catch {
                            return line;
                        }
                    });
            } else {
                const singleValue = singleInput.value.trim();
                if (!singleValue) return [];

                try {
                    const parsed = JSON.parse(singleValue);
                    return Array.isArray(parsed) ? parsed : [parsed];
                } catch {
                    return singleValue.split(',').map(item => {
                        const trimmed = item.trim();
                        try {
                            return JSON.parse(trimmed);
                        } catch {
                            return trimmed;
                        }
                    });
                }
            }
        }

        function updateJsonPreview() {
            try {
                const config = getCurrentFormConfig();
                const jsonString = JSON.stringify(config, null, 2);
                const previewElement = document.getElementById('jsonPreview');

                if (previewElement) {
                    previewElement.textContent = jsonString;
                    checkForChanges();
                } else {
                    setTimeout(updateJsonPreview, 50);
                }
            } catch (error) {
                console.error('Error updating JSON preview:', error);
                const previewElement = document.getElementById('jsonPreview');
                if (previewElement) {
                    previewElement.textContent = 'Error generating JSON preview: ' + (error instanceof Error ? error.message : String(error));
                }
            }
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            const errorElement = document.getElementById('errorMessage');
            errorElement.style.display = 'none';
        }

        function addField() {
            const name = document.getElementById('newPropName').value.trim();
            const value = document.getElementById('newPropValue').value.trim();

            if (!name) {
                alert('Please enter a property name');
                return;
            }

            addPropertyField(name, value);

            document.getElementById('newPropName').value = '';
            document.getElementById('newPropValue').value = '';

            updateJsonPreview();
        }

        function removeField(fieldName) {
            const field = document.querySelector('input[name="' + fieldName + '"]');
            if (field && field.parentElement) {
                field.parentElement.remove();
                updateJsonPreview();
            }
        }

        function saveConfiguration() {
            hideError();
            const config = getCurrentFormConfig();
            vscode.postMessage({
                command: 'saveConfiguration',
                config: config
            });
        }

        function reset() {
            if (isDirty) {
                const result = confirm('Are you sure you want to reset all changes?');
                if (!result) {
                    return;
                }
            }

            // Close current page and reopen the configuration
            const configName = document.getElementById('configName').value || 'unknown';
            vscode.postMessage({
                command: 'resetConfiguration',
                configName: configName
            });
        }

        function runConfiguration() {
            hideError();
            const config = getCurrentFormConfig();
            vscode.postMessage({
                command: 'runConfiguration',
                config: config
            });
        }

        function openLaunchJson() {
            vscode.postMessage({
                command: 'openLaunchJson'
            });
        }

        function debugConfiguration() {
            hideError();
            const config = getCurrentFormConfig();
            vscode.postMessage({
                command: 'debugConfiguration',
                config: config
            });
        }

        // Listen for messages from the extension
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'initialize':
                    initializePage(message.data);
                    break;
                case 'showError':
                    showError(message.message);
                    break;
                case 'setEnvFile':
                    document.getElementById('envFile').value = message.path;
                    updateJsonPreview();
                    break;
                case 'setProgram':
                    document.getElementById('configProgram').value = message.path;
                    updateJsonPreview();
                    break;
                case 'setCwd':
                    document.getElementById('configCwd').value = message.path;
                    updateJsonPreview();
                    break;
                case 'showEnvFileError':
                    showError(message.message);
                    break;
                case 'saveSuccess':
                    // Update initial configuration after successful save
                    initialConfig = JSON.stringify(message.config, null, 2);
                    isDirty = false;
                    document.title = document.title.replace(/^[‚óè]\s*/, '');
                    hideError();
                    updateJsonPreview();
                    break;
                case 'refreshUI':
                    setTimeout(() => {
                        debugDomElements();
                        updateJsonPreview();
                    }, 100);
                    break;
            }
        });

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                debugDomElements();

                // Send ready message to extension to initialize data
                vscode.postMessage({
                    command: 'ready'
                });
            });
        } else {
            // DOM is already loaded, initialize immediately
            debugDomElements();
            vscode.postMessage({
                command: 'ready'
            });
        }

        window.addEventListener('beforeunload', (event) => {
            if (isDirty) {
                event.preventDefault();
                event.returnValue = '';
            }
        });
    </script>
</body>

</html>